<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProbSolver - AI Math Tutor</title>
    <meta name="description" content="ProbSolver - Advanced AI-powered math problem solver with step-by-step solutions, voice input, and image recognition">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 48rem;
            margin: 0 auto;
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            padding: 2rem 0;
            transition: all 0.5s ease;
        }
        
        .header.minimized {
            padding: 1rem 0;
        }
        
        .header.hidden {
            display: none;
        }
        
        .title {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        
        .header.minimized .title {
            font-size: 1.5rem;
        }
        
        .subtitle {
            width: 4rem;
            height: 2px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            margin: 0 auto;
        }
        
        .header.minimized .subtitle {
            width: 2rem;
            height: 1px;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }
        
        .message {
            margin-bottom: 1.5rem;
            animation: slideUp 0.3s ease-out;
        }
        
        .user-message {
            display: flex;
            justify-content: flex-end;
        }
        
        .user-message .content {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border-bottom-right-radius: 0.25rem;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .ai-message {
            display: flex;
            justify-content: flex-start;
        }
        
        .ai-message .content {
            background: #1e293b;
            border: 1px solid #334155;
            padding: 1.5rem;
            border-radius: 1rem;
            border-bottom-left-radius: 0.25rem;
            width: 100%;
            word-wrap: break-word;
        }
        
        .solution-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #334155;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .action-btn {
            background: #374151;
            color: #d1d5db;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .action-btn:hover {
            background: #4b5563;
            color: white;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            color: #94a3b8;
        }
        
        .loading-dots {
            display: flex;
            gap: 0.25rem;
            margin-right: 0.5rem;
        }
        
        .dot {
            width: 0.5rem;
            height: 0.5rem;
            background: #3b82f6;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite both;
        }
        
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0s; }
        
        .input-section {
            position: sticky;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 1rem 0;
        }
        
        .image-preview {
            margin-bottom: 1rem;
            display: none;
        }
        
        .image-preview.show {
            display: block;
        }
        
        .image-container {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 1rem;
            padding: 1rem;
            position: relative;
            max-width: 20rem;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 12rem;
            border-radius: 0.5rem;
            object-fit: contain;
        }
        
        .remove-image {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .input-bar {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 1.5rem;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s;
        }
        
        .input-bar:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .input-field {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #e2e8f0;
            font-size: 0.875rem;
        }
        
        .input-field::placeholder {
            color: #64748b;
        }
        
        .input-btn {
            background: transparent;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .input-btn:hover {
            color: #e2e8f0;
            background: #374151;
        }
        
        .input-btn.recording {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .typewriter-cursor {
            animation: blink 1s infinite;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Math styles */
        .katex-display {
            margin: 1rem 0;
        }
        
        /* Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Markdown styles */
        h2 { color: #60a5fa; font-size: 1.125rem; font-weight: 600; margin: 1.5rem 0 0.75rem 0; }
        p { margin-bottom: 0.75rem; line-height: 1.6; }
        p:last-child { margin-bottom: 0; }
        
        /* Responsive */
        @media (max-width: 640px) {
            .container { padding: 0.5rem; }
            .title { font-size: 2rem; }
            .user-message .content { max-width: 85%; }
            .action-buttons { gap: 0.25rem; }
            .action-btn { padding: 0.375rem 0.5rem; font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header" id="header">
            <h1 class="title">ProbSolver</h1>
            <div class="subtitle"></div>
        </header>
        
        <main class="chat-container" id="chatContainer">
            <!-- Messages will be added here -->
        </main>
        
        <div class="loading hidden" id="loading">
            <div class="loading-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            <span>ProbSolver is thinking...</span>
        </div>
        
        <section class="input-section">
            <div class="image-preview" id="imagePreview">
                <div class="image-container">
                    <img id="previewImg" class="preview-image" alt="Preview">
                    <button class="remove-image" id="removeImage">×</button>
                </div>
            </div>
            
            <div class="input-bar">
                <input
                    type="text"
                    class="input-field"
                    id="inputField"
                    placeholder="Ask ProbSolver anything..."
                    autocomplete="off"
                />
                
                <label for="imageUpload" class="input-btn" title="Upload image">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                </label>
                <input type="file" id="imageUpload" class="hidden" accept="image/*">
                
                <label for="cameraUpload" class="input-btn" title="Take photo">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 17c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm1.5-9H17v10.5c0 1.1-.9 2-2 2h-1V13c0-2.76-2.24-5-5-5H7.5V6.5c0-1.1.9-2 2-2h4z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </label>
                <input type="file" id="cameraUpload" class="hidden" accept="image/*" capture="environment">
                
                <button class="input-btn" id="voiceBtn" title="Voice input">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14c1.77 0 3-1.23 3-3V5c0-1.77-1.23-3-3-3S9 3.23 9 5v6c0 1.77 1.23 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
                    </svg>
                </button>
                
                <button class="input-btn" id="sendBtn" title="Send">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </section>
    </div>

    <script>
        class ProbSolver {
            constructor() {
                this.API_KEY = 'AIzaSyDEeJkrym65-ZGNzTpY6_wHEMhoDETFX4w';
                this.messages = [];
                this.uploadedImage = null;
                this.currentProblem = '';
                this.isLoading = false;
                this.recognition = null;
                this.isRecording = false;
                
                this.initElements();
                this.initEventListeners();
                this.initSpeechRecognition();
            }
            
            initElements() {
                this.header = document.getElementById('header');
                this.chatContainer = document.getElementById('chatContainer');
                this.loading = document.getElementById('loading');
                this.inputField = document.getElementById('inputField');
                this.imagePreview = document.getElementById('imagePreview');
                this.previewImg = document.getElementById('previewImg');
                this.removeImage = document.getElementById('removeImage');
                this.imageUpload = document.getElementById('imageUpload');
                this.cameraUpload = document.getElementById('cameraUpload');
                this.voiceBtn = document.getElementById('voiceBtn');
                this.sendBtn = document.getElementById('sendBtn');
            }
            
            initEventListeners() {
                this.sendBtn.addEventListener('click', () => this.handleSend());
                this.inputField.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.handleSend();
                    }
                });
                
                this.imageUpload.addEventListener('change', (e) => this.handleImageUpload(e));
                this.cameraUpload.addEventListener('change', (e) => this.handleImageUpload(e));
                this.removeImage.addEventListener('click', () => this.clearImage());
                this.voiceBtn.addEventListener('click', () => this.toggleVoice());
                
                // Paste handler
                document.addEventListener('paste', (e) => this.handlePaste(e));
            }
            
            initSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onstart = () => {
                        this.isRecording = true;
                        this.voiceBtn.classList.add('recording');
                        this.inputField.placeholder = 'Listening...';
                    };
                    
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.inputField.value = transcript;
                    };
                    
                    this.recognition.onend = () => {
                        this.isRecording = false;
                        this.voiceBtn.classList.remove('recording');
                        this.inputField.placeholder = 'Ask ProbSolver anything...';
                    };
                } else {
                    this.voiceBtn.style.display = 'none';
                }
            }
            
            handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.uploadedImage = {
                        data: e.target.result.split(',')[1],
                        mimeType: file.type
                    };
                    this.previewImg.src = e.target.result;
                    this.imagePreview.classList.add('show');
                    this.inputField.placeholder = 'Image ready to analyze...';
                };
                reader.readAsDataURL(file);
            }
            
            handlePaste(event) {
                const items = event.clipboardData?.items;
                if (!items) return;
                
                for (const item of Array.from(items)) {
                    if (item.type.indexOf('image') !== -1) {
                        const blob = item.getAsFile();
                        if (blob) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this.uploadedImage = {
                                    data: e.target.result.split(',')[1],
                                    mimeType: blob.type
                                };
                                this.previewImg.src = e.target.result;
                                this.imagePreview.classList.add('show');
                                this.inputField.placeholder = 'Image ready to analyze...';
                            };
                            reader.readAsDataURL(blob);
                            break;
                        }
                    }
                }
            }
            
            clearImage() {
                this.uploadedImage = null;
                this.imagePreview.classList.remove('show');
                this.inputField.placeholder = 'Ask ProbSolver anything...';
            }
            
            toggleVoice() {
                if (!this.recognition) return;
                
                if (this.isRecording) {
                    this.recognition.stop();
                } else {
                    this.recognition.start();
                }
            }
            
            addMessage(content, sender, isImage = false) {
                const messageId = Date.now().toString();
                const message = {
                    id: messageId,
                    content,
                    sender,
                    isImage,
                    showActions: false
                };
                
                this.messages.push(message);
                this.renderMessage(message);
                this.scrollToBottom();
                
                return messageId;
            }
            
            renderMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender}-message`;
                messageDiv.id = `message-${message.id}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';
                
                if (message.isImage) {
                    const img = document.createElement('img');
                    img.src = message.content;
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '0.5rem';
                    contentDiv.appendChild(img);
                } else {
                    if (message.sender === 'ai' && !message.isImage) {
                        const header = document.createElement('div');
                        header.className = 'solution-header';
                        header.textContent = 'Solution';
                        contentDiv.appendChild(header);
                    }
                    
                    const textDiv = document.createElement('div');
                    textDiv.innerHTML = message.content;
                    contentDiv.appendChild(textDiv);
                }
                
                messageDiv.appendChild(contentDiv);
                this.chatContainer.appendChild(messageDiv);
            }
            
            updateMessage(messageId, content, showActions = false) {
                const messageElement = document.getElementById(`message-${messageId}`);
                if (!messageElement) return;
                
                const contentDiv = messageElement.querySelector('.content > div:last-child') || 
                                 messageElement.querySelector('.content');
                
                if (contentDiv.tagName === 'DIV' && contentDiv.innerHTML !== undefined) {
                    contentDiv.innerHTML = content;
                } else {
                    contentDiv.innerHTML = content;
                }
                
                if (showActions && !messageElement.querySelector('.action-buttons')) {
                    this.addActionButtons(messageElement);
                }
                
                // Render math
                this.renderMath(messageElement);
            }
            
            addActionButtons(messageElement) {
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'action-buttons';
                
                const buttons = [
                    { text: '✨ Explain Concept', action: 'explain' },
                    { text: '✨ Practice Problems', action: 'practice' },
                    { text: '📝 Shorten it', action: 'shorten' }
                ];
                
                buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.className = 'action-btn';
                    button.textContent = btn.text;
                    button.addEventListener('click', () => this.handleAction(btn.action));
                    buttonsDiv.appendChild(button);
                });
                
                messageElement.querySelector('.content').appendChild(buttonsDiv);
            }
            
            async handleAction(action) {
                if (!this.currentProblem) return;
                
                let prompt, title;
                switch (action) {
                    case 'explain':
                        prompt = `Explain the core mathematical concept behind this problem in simple terms: "${this.currentProblem}"`;
                        title = 'Concept Explanation';
                        break;
                    case 'practice':
                        prompt = `Generate 3 similar practice problems based on: "${this.currentProblem}". Include solutions.`;
                        title = 'Practice Problems';
                        break;
                    case 'shorten':
                        prompt = `Create a concise summary of the key steps to solve: "${this.currentProblem}"`;
                        title = 'Summary';
                        break;
                }
                
                await this.processMessage(prompt, title);
            }
            
            async handleSend() {
                const text = this.inputField.value.trim();
                if (!text && !this.uploadedImage) return;
                
                this.currentProblem = text;
                
                // Minimize header after first message
                if (this.messages.length === 0) {
                    this.header.classList.add('minimized');
                }
                
                // Add user messages
                if (text) {
                    this.addMessage(text, 'user');
                }
                if (this.uploadedImage) {
                    this.addMessage(`data:${this.uploadedImage.mimeType};base64,${this.uploadedImage.data}`, 'user', true);
                }
                
                // Clear input
                this.inputField.value = '';
                this.clearImage();
                
                await this.processMessage(text, 'Solution');
            }
            
            async processMessage(prompt, title = 'Solution') {
                if (this.isLoading) return;
                
                this.isLoading = true;
                this.loading.classList.remove('hidden');
                
                try {
                    const response = await this.callGeminiAPI(prompt);
                    this.loading.classList.add('hidden');
                    
                    const messageId = this.addMessage('', 'ai');
                    await this.typewriterEffect(messageId, response, title === 'Solution');
                    
                } catch (error) {
                    this.loading.classList.add('hidden');
                    this.addMessage('⚠️ Sorry, I encountered an error. Please try again.', 'ai');
                    console.error('API Error:', error);
                } finally {
                    this.isLoading = false;
                }
            }
            
            async callGeminiAPI(prompt) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${this.API_KEY}`;
                
                const parts = [{ text: prompt }];
                if (this.uploadedImage) {
                    parts.push({
                        inlineData: {
                            mimeType: this.uploadedImage.mimeType,
                            data: this.uploadedImage.data
                        }
                    });
                }
                
                const payload = {
                    contents: [{ parts }],
                    systemInstruction: {
                        parts: [{
                            text: "You are an expert math tutor. Provide clear, step-by-step solutions using markdown formatting. Use LaTeX for mathematical expressions (wrap in $ for inline math, $$ for display math). Be concise but thorough."
                        }]
                    }
                };
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const result = await response.json();
                return result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not process your request.';
            }
            
            async typewriterEffect(messageId, text, showActions = false) {
                const words = text.split(' ');
                let currentText = '';
                
                for (let i = 0; i < words.length; i++) {
                    currentText += words[i] + ' ';
                    
                    // Parse and render content with math during typing
                    let displayText = this.parseMarkdown(currentText);
                    displayText += '<span class="typewriter-cursor">|</span>';
                    
                    this.updateMessage(messageId, displayText);
                    await new Promise(resolve => setTimeout(resolve, 30));
                }
                
                // Final render without cursor
                const finalContent = this.parseMarkdown(text);
                this.updateMessage(messageId, finalContent, showActions);
            }
            
            parseMarkdown(text) {
                let html = text
                    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                    .replace(/^\* (.+)$/gm, '<p style="margin-left: 1.5rem;">• $1</p>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/^(?!<h2|<p style)(.+)$/gm, '<p>$1</p>')
                    .replace(/<p><\/p>/g, '');
                
                // Handle LaTeX math expressions
                html = html.replace(/\$\$(.*?)\$\$/g, (match, math) => {
                    try {
                        return katex.renderToString(math, { displayMode: true });
                    } catch (e) {
                        return match;
                    }
                });
                
                html = html.replace(/\$([^$]+)\$/g, (match, math) => {
                    try {
                        return katex.renderToString(math, { displayMode: false });
                    } catch (e) {
                        return match;
                    }
                });
                
                return html;
            }
            
            renderMath(element) {
                if (window.renderMathInElement) {
                    renderMathInElement(element, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false}
                        ]
                    });
                }
            }
            
            scrollToBottom() {
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }
        }
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ProbSolver();
        });
    </script>
</body>
</html>